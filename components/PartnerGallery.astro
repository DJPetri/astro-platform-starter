---
// Keine Props, alles clientseitig
---

<div id="gallery">Lade Partner...</div>

<script type="module">
  async function fetchPartnerUrls() {
    const res = await fetch('/data/partners.json');
    if (!res.ok) throw new Error('Partner-URLs konnten nicht geladen werden');
    return await res.json();
  }

  async function fetchMetadata(url) {
    try {
      const res = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`);
      if (!res.ok) throw new Error('Microlink API Fehler');
      const { data } = await res.json();
      return {
        url,
        title: data.title || url,
        description: data.description || '',
        image: data.image?.url || '/fallback.png'
      };
    } catch {
      return {
        url,
        title: url,
        description: 'Keine Vorschau verfügbar.',
        image: '/fallback.png'
      };
    }
  }


  async function loadGallery() {
    const gallery = document.getElementById('gallery');
    gallery.textContent = '';

    try {
      const urls = await fetchPartnerUrls();

      // Platzhalter-Karten einfügen
      const placeholderCards = urls.map(() => {
        const placeholder = document.createElement('div');
        placeholder.className = 'gallery-card loading';
        placeholder.innerHTML = `
          <img src="/loader.gif" alt="Lade..." />
          <h3>Lädt...</h3>
          <p>Vorschau wird geladen</p>
        `;
        gallery.appendChild(placeholder);
        return placeholder;
      });

      // Metadaten laden und Platzhalter ersetzen
      urls.forEach(async (url, index) => {
        const data = await fetchMetadata(url);
        const card = document.createElement('a');
        card.href = data.url;
        card.target = '_blank';
        card.className = 'gallery-card';
        card.innerHTML = `
          <img src="${data.image}" alt="${data.title}" />
          <h3>${data.title}</h3>
          <p>${data.description}</p>
        `;

        gallery.replaceChild(card, placeholderCards[index]);
      });

    } catch (e) {
      gallery.textContent = 'Fehler beim Laden der Partner.';
      console.error(e);
    }
  }

  loadGallery();
</script>